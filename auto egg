-- Egg Data Table
local extraEggNames = {}

-- Stats Variables
local eggsHatched = 0
local hatchStartTime = 0
local isHatching = false

-- Function to scan workspace for available Eggs (Includes worlds with numbers)
local function getEggNames()
    local eggNamesSet = {}
    local zones = workspace:FindFirstChild("Zones")

    if zones then
        for _, world in pairs(zones:GetChildren()) do

            -- Skip AdminEvent
            if world.Name == "AdminEvent" then
                continue
            end

            -- Look at ALL Folders (No number check)
            if world:IsA("Folder") then

                local eggsFolder
                local interactables = world:FindFirstChild("Interactables")

                if interactables and interactables:FindFirstChild("Eggs") then
                    eggsFolder = interactables.Eggs
                elseif world:FindFirstChild("Eggs") then
                    eggsFolder = world.Eggs
                end

                if eggsFolder then
                    for _, egg in ipairs(eggsFolder:GetChildren()) do
                        if not egg.Name:lower():find("rewind") then
                            local name = egg.Name
                            name = name:gsub("%s*[Ee][Gg][Gg]%s*$", "")
                            name = name:match("^%s*(.-)%s*$")

                            -- Fix specific name if needed
                            if name == "IceSpiked" then
                                name = "IceSpikes"
                            end

                            eggNamesSet[name] = true
                        end
                    end
                end
            end
        end
    end

    for _, extraName in ipairs(extraEggNames) do
        eggNamesSet[extraName] = true
    end

    local eggNames = {}
    for name in pairs(eggNamesSet) do
        table.insert(eggNames, name)
    end
    table.sort(eggNames)

    return eggNames
end

-- Load UI Library
local Library = loadstring(game:HttpGet("https://github.com/ActualMasterOogway/Fluent-Renewed/releases/latest/download/Fluent.luau"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/bigbeanscripts/Pet-Warriors/refs/heads/main/test"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/ActualMasterOogway/Fluent-Renewed/master/Addons/InterfaceManager.luau"))()

-- Create Window
local Window = Library:Window{
    Title = "Christmas Event - Eggs Only",
    SubTitle = "By Duckie",
    TabWidth = 160,
    Size =  UDim2.fromOffset(580, 460),
    Resize = false, 
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.LeftShift
}

-- Create Tabs
local Tabs = {
    Eggs = Window:AddTab({ Title = "Eggs", Icon = "egg" }),
}

-- Egg Section
local EggSection = Tabs.Eggs:AddSection("Eggs")

-- Hatch Amount Dropdown
local HatchAmountDropdown = Tabs.Eggs:AddDropdown("HatchAmount", {
    Title = "Hatch Amount",
    Values = {"1x", "3x", "8x", "30x", "Max"},
    Multi = false,
    Searchable = true,
    Default = "1x"
})

-- Egg Selection Dropdown (Populated Dynamically)
local eggNames = getEggNames()
local EggDropdown = Tabs.Eggs:AddDropdown("EggSelect", {
    Title = "Select Egg",
    Values = eggNames,
    Multi = false,
    Searchable = true,
    Default = eggNames[1] or "None"
})

-- Speed Display UI
local SpeedDisplay = EggSection:Paragraph("SpeedDisplay", {
    Title = "Hatch Stats",
    Content = "Speed: 0.00 Eggs/s\nTotal: 0"
})

-- Background Loop to Update Speed
spawn(function()
    while true do
        wait(0.5) -- Update display every 0.5 seconds
        if isHatching and hatchStartTime > 0 then
            local elapsed = tick() - hatchStartTime
            local speed = (eggsHatched / elapsed)
            SpeedDisplay:SetValue(string.format("Speed: %.2f Eggs/s\nTotal: %d", speed, eggsHatched))
        else
             SpeedDisplay:SetValue(string.format("Speed: 0.00 Eggs/s\nTotal: %d", eggsHatched))
        end
    end
end)

-- Auto Hatch Toggle (Accurate Counting)
local AutoHatchToggle = Tabs.Eggs:AddToggle("AutoHatch", {
    Title = "Auto Hatch (Accurate)",
    Default = false
})

AutoHatchToggle:OnChanged(function()
    if AutoHatchToggle.Value then
        -- Reset stats
        isHatching = true
        eggsHatched = 0
        hatchStartTime = tick()
        
        spawn(function()
            while AutoHatchToggle.Value do
                local selectedEgg = EggDropdown.Value
                local hatchMultiplier = HatchAmountDropdown.Value

                local args = {}

                -- Determine arguments
                if hatchMultiplier == "1x" then
                    args = {selectedEgg, nil, nil, false, nil}
                elseif hatchMultiplier == "3x" then
                    args = {selectedEgg, nil, true, false}
                elseif hatchMultiplier == "8x" then
                    args = {selectedEgg, nil, false, true, true}
                elseif hatchMultiplier == "30x" or hatchMultiplier == "Max" then
                    args = {selectedEgg, nil, nil, false, nil, true}
                end

                -- Invoke server and capture the result safely
                local success, result = pcall(function()
                    return game:GetService("ReplicatedStorage").Packages.Knit.Services.EggService.RF.purchaseEgg:InvokeServer(unpack(args))
                end)

                -- Only count if the hatch was successful
                if success and result then
                    -- If the server returns a table of pets, count the exact number
                    if type(result) == "table" then
                        eggsHatched = eggsHatched + #result
                    elseif result == true then
                        -- Fallback: If the game only returns 'true' (success) without data,
                        -- we estimate based on your selection (1x, 3x, etc.)
                        local batchSize = 1
                        if hatchMultiplier == "3x" then batchSize = 3
                        elseif hatchMultiplier == "8x" then batchSize = 8
                        elseif hatchMultiplier == "30x" or hatchMultiplier == "Max" then batchSize = 30
                        end
                        eggsHatched = eggsHatched + batchSize
                    end
                else
                    -- If failed (e.g. No Currency, Full Inventory), we do NOT add to total
                    task.wait(0.1) -- Small delay to prevent spamming errors too fast
                end
            end
        end)
    else
        isHatching = false
    end
end)

-- Manager Setup (Minimal)
SaveManager:SetLibrary(Library)
InterfaceManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")

SaveManager:LoadAutoloadConfig()
